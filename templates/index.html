<script>
const MAX_POINTS = 30;
const labels = [];
const tempData = [];

const thresholdInput = document.getElementById('thresholdInput');
const ctx = document.getElementById('tempChart').getContext('2d');

/* ------------------ CHART ------------------ */
const tempChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels,
    datasets: [{
      label: 'Temperature (°C)',
      data: tempData,
      tension: 0.3,
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { labels: { color: '#e6f7ff' } }
    },
    scales: {
      x: { ticks: { color: '#aaa' } },
      y: { ticks: { color: '#aaa' } }
    }
  }
});

/* ---------- LOAD THRESHOLD ONCE ---------- */
async function loadThresholdOnce() {
  try {
    const res = await fetch('/api/get_data');
    const data = await res.json();
    thresholdInput.value = data.threshold;
  } catch (e) {
    console.error('Failed to load threshold', e);
  }
}

/* ---------- LIVE DATA FETCH ---------- */
async function fetchLiveData() {
  try {
    const res = await fetch('/api/get_data');
    const data = await res.json();

    const now = new Date().toLocaleTimeString();

    document.getElementById('tempVal').textContent =
      data.temperature.toFixed(1) + ' °C';

    document.getElementById('humVal').textContent =
      data.humidity.toFixed(1) + ' %';

    document.getElementById('buzzerState').textContent =
      data.temperature >= data.threshold ? 'ON' : 'OFF';

    labels.push(now);
    tempData.push(data.temperature);

    if (labels.length > MAX_POINTS) {
      labels.shift();
      tempData.shift();
    }

    tempChart.update();

  } catch (e) {
    console.error('Live update failed', e);
  }
}

/* ---------- SEND THRESHOLD (DEBOUNCED) ---------- */
let thresholdTimeout;
thresholdInput.addEventListener('input', () => {
  clearTimeout(thresholdTimeout);
  thresholdTimeout = setTimeout(async () => {
    await fetch('/api/set_threshold', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ threshold: thresholdInput.value })
    });
  }, 600); // send after user stops typing
});

/* ---------- INIT ---------- */
loadThresholdOnce();
fetchLiveData();
setInterval(fetchLiveData, 2000);
</script>
